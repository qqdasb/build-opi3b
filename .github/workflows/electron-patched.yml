name: Build Electron with Rockchip MPP Patches

on:
  push:
    branches: [ "electron" ]
  pull_request:
    branches: [ "electron" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Free Disk Space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true
    - uses: actions/setup-node@v4
      with:
        node-version: 22.13.0
    - name: Install Depends from Package Manager
      run: |
        sudo apt-get update
        sudo apt-get install build-essential clang libdbus-1-dev libgtk-3-dev libnotify-dev libasound2-dev libcap-dev libcups2-dev libxtst-dev libxss1 libnss3-dev curl gperf bison python3-dbusmock openjdk-8-jre libc6-dev-arm64-cross linux-libc-dev-arm64-cross g++-14-aarch64-linux-gnu ninja-build generate-ninja
        sudo npm i -g npm@11.0.0
        sudo npm i -g @electron/build-tools
        git clone https://github.com/electron/build-tools --depth 1 ~/.electron_build_tools && (cd ~/.electron_build_tools && npm install
    - name: Init and Sync Source
      run: |
        e init rkmpp-release --import release --fork qqdasb/electron --target-cpu arm64 --use-https --root=./src
        sed -i 's|electron/electron|qqdasb/electron-rkmpp|g' src/.gclient
        export PATH=$PATH:/home/runner/.electron_build_tools/third_party/depot_tools
        gclient config --name "src/electron" --unmanaged https://github.com/qqdasb/electron-rkmpp
        gclient sync --with_branch_heads --with_tags --no-history
    - name: Install Depends from Electron
      run: |
        cd src
        export CHROMIUM_BUILDTOOLS_PATH=$(pwd)/buildtools
        ./build/install-build-deps.sh --no-android
        ./build/linux/sysroot_scripts/install-sysroot.py --arch=arm64
    - name: Build and Package
      run: |
        cd src
        e build --target electron:electron_dist_zip -v
        find -name *.zip
    - uses: actions/upload-artifact@v4
      with:
        name: Electron-With-RKMPP
        path: /home/runner/work/build-opi3b/build-opi3b/src/out/Release*
